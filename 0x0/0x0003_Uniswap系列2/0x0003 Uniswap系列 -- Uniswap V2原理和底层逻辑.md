---
创建时间: 2025-01-11 22:28
更新时间: 2025-01-13 16:42
---

![[你的段落文字 (3).png]](./img/你的段落文字%20(3).png)
# 引言

Hello，大家好，我是Momo。作为一名区块链技术学习者，我将把学习过程中的心得整理成文章与大家分享。本文是0x0系列的第一篇，主要介绍区块链基础相关知识，欢迎志同道合的朋友一起交流讨论。

本系列所有代码和教程开源在Github - >【Web3-Learning】


# 0x00 前言

Uniswap V2作为去中心化金融（DeFi）领域的重要里程碑，凭借其创新的技术架构和底层逻辑，为加密货币交易带来了革命性的变革。本次Momo将深入探讨Uni V2的核心技术细节，主要分析其自动做市商（AMM）机制、合约设计、安全性以及与其他DeFi协议交互等方面的优势与特点，希望能够用自己直白的语言，以更好地让大家理解Uni V2的运作原理。

![[Pasted image 20250113152213.png]](./img/Pasted%20image%2020250113152213.png)
# 0x01 Uniswap V2的核心架构


## 合约体系

Uniswap V2由一系列智能合约组成，主要包括工厂合约（UniswapV2Factory）、交易对合约（UniswapV2Pair）以及路由合约（UniswapV2Router02）等。这些合约相互协作，共同构建起一个去中心化的交易生态系统。

1. 工厂合约（UniswapV2Factory）

	• 工厂合约是Uniswap V2的核心组件之一，负责创建和管理所有交易对合约。它持有支持交易对合约的通用字节码，当用户想要创建一个新的交易对时，工厂合约会根据输入的两个代币地址，生成一个唯一的交易对合约地址，并部署相应的交易对合约。这一过程不仅简化了交易对的创建流程，还确保了每个交易对的唯一性和可追溯性。
	
	• 此外，工厂合约还包含开启协议费用的逻辑。虽然Uniswap V2的合约通常是不可升级的，但通过在工厂合约中修改一个变量，可以允许协议针对每笔交易收取一定比例的手续费。这一机制为协议的未来发展提供了灵活性，也为流动性提供者（LP）的收益分配提供了更多的可能性。


2. 交易对合约（UniswapV2Pair）

	• 交易对合约是Uniswap V2中实现自动做市商功能的关键合约。每个交易对合约管理着由两个ERC-20代币（Token0和Token1）组成的流动池，这两个代币的储备量分别存储在合约中。交易对合约的核心功能是根据“恒定乘积做市商”机制，即x * y=k（x和y分别代表两种代币的储备量，k为常数），来确定交易价格并执行代币交换。
	
	• 除了自动做市商功能外，交易对合约还负责跟踪和更新价格累积变量（price0CumulativeLast和price1CumulativeLast），这些变量用于计算时间加权平均价格（TWAP），为价格预言机功能提供数据支持。每当交易对合约中的储备量发生变化时，会通过_update()函数更新这些价格累积变量，从而记录整个合约历史中每一秒的Uniswap价格总和，为其他以太坊合约提供可靠的链上价格数据。


3. 路由合约（UniswapV2Router02）

	• 路由合约是用户与Uniswap V2交互的主要接口，它提供了一系列的交易和流动性管理功能。用户可以通过路由合约发起代币交换请求，路由合约会根据用户指定的交易路径，调用相应的交易对合约来完成交易。例如，在进行多跳兑换时，路由合约会遍历整个兑换路径，并对路径中每两个交易对的代币调用交易对合约的兑换函数，实现底层的兑换处理。
	
	• 除了交易功能外，路由合约还支持流动性提供者添加和移除流动性。当流动性提供者想要向流动池中添加流动性时，路由合约会将用户的代币发送到相应的交易对合约，并从交易对合约中获取流动性代币（LPT），然后将LPT发送给流动性提供者。相反，当流动性提供者想要移除流动性时，路由合约会将LPT发送到交易对合约，从交易对合约中提取相应的两种代币资产，并将它们发送给流动性提供者。


## 技术优势

1. 任意ERC-20代币交易对支持

	• Uniswap V2的一个重大创新是支持任意ERC-20代币之间的交易对，而不再局限于Uniswap V1中ERC-20与ETH之间的交易对。这一特性极大地拓展了Uniswap的交易范围和应用场景，使得更多的代币能够在Uniswap上进行自由交易，为DeFi生态系统的繁荣发展提供了更广阔的空间。例如，用户现在可以直接在Uniswap V2上交易DAI和USDC这两种稳定币，而无需先将它们兑换成ETH，从而降低了交易成本和滑点风险。


2. 价格预言机功能

	• Uniswap V2引入了价格预言机功能，通过在每个区块开始时累计两种代币的相对价格，为其他以太坊合约提供了获取任意时间段内两种代币时间加权平均价格的能力。这种基于链上交易数据的预言机机制，具有高度的去中心化和抗篡改性，相比传统的链下预言机方案，能够提供更实时、更准确且更安全的价格信息。许多DeFi项目，如借贷协议、合成资产协议等，都可以利用Uniswap V2的价格预言机来获取资产的市场价格，从而实现更精准的风险评估和定价策略。


3. 闪电贷功能

	• 闪电贷是Uniswap V2的另一项创新特性，允许用户在链上自由借出并使用代币，只需在该交易的最后归还这些代币并支付一定手续费即可。这一功能为用户提供了极大的灵活性，使得用户可以在同一笔交易中完成复杂的操作，如套利、清算等。简单举个例子：用户可以编写程序，利用闪电贷0抵押借出一笔资金，通过一系列交易操作获取利润，然后在交易结束前归还借出的资金，整个过程因为在单个区块内完成，且根据EVM的原子特性（原子性：一个操作要么全部执行，诺出错则全部不执行），无需担心资金的流动性问题。闪电贷的出现，进一步丰富了DeFi的玩法和应用场景，也为用户创造了更多的盈利机会，还能快速且被动的将相关币对的价格趋于平衡。


# 0x02 Uniswap V2的底层逻辑


## 恒定乘积做市商机制

### 原理 x * y = k

Uniswap V2采用“恒定乘积做市商”机制来确定交易价格和执行代币交换。在每个配对合约中，两种代币的储备量x和y满足x * y=k的关系，其中k为常数。当用户发起一笔交易，用代币A兑换代币B时，配对合约会根据这一公式计算出用户需要支付的代币A数量和能够获得的代币B数量。具体计算过程如下：

• 首先，计算交易前配对合约中代币A和代币B的储备量x0和y0，以及常数k0=x0 * y0。

• 然后，根据用户想要获得的代币B数量Δy，计算出交易后配对合约中代币B的储备量y1=y0-Δy。

• 由于恒定乘积公式x * y=k保持不变，可以得出交易后配对合约中代币A的储备量x1=k0/y1。

• 最后，计算出用户需要支付的代币A数量Δx=x1-x0，即用户需要支付Δx数量的代币A，才能从配对合约中兑换出Δy数量的代币B。

![[Pasted image 20250111232544.png]](./img/Pasted%20image%2020250111232544.png)

### 特点

这种机制具有以下特点：

- 价格滑点
	由于交易会改变配对合约中代币的储备量，从而导致交易价格发生变化，这种价格变化称为滑点。滑点的大小与交易量相对于储备量的比例有关，交易量越大，滑点越高。例如，在一个储备量较小的交易对中进行大额交易，可能会导致较高的滑点，使得用户实际获得的代币数量少于预期。因此，用户在进行交易时需要考虑滑点的影响，合理选择交易金额和交易时机。

- 流动性提供者的收益
	流动性提供者通过向流动池中添加流动性，可以获得交易手续费作为收益。每当用户在配对合约中进行交易时，Uniswap V2会收取一定比例的手续费（默认为0.3%），并将这些手续费加入到储备金中。流动性提供者在提取流动性时，可以根据自己在流动池中的份额，获得相应的手续费收益。此外，由于交易会增加储备金的总量，从而提高k值，流动性提供者在提取流动性时还可能获得因k值增加而带来的额外收益。

![[Pasted image 20250111232413.png]](./img/Pasted%20image%2020250111232413.png)
## 流动性管理逻辑

流动性是Uniswap V2正常运行的基础，流动性提供者的参与对于维持交易对的流动性和价格稳定性至关重要。Uniswap V2通过一系列机制来鼓励和管理流动性提供者的行为。


- 流动性代币（LP）机制

	- 当流动性提供者向流动池中添加流动性时，配对合约会根据添加的代币数量和流动池中的总流动性，计算出流动性提供者应获得的流动性代币数量，并将这些LP发送给流动性提供者。LP代表了流动性提供者在流动池中的份额，流动性提供者可以随时通过燃烧LP来提取相应的两种代币资产。
	
	- LP的数量与流动池中的总流动性成正比，这意味着流动性提供者在流动池中的份额越大，其对交易价格的影响也越大。同时，LP也可以在二级市场上进行交易、抵押等，为流动性提供者提供了更多的资金管理和风险控制手段。例如，当流动性提供者认为某个交易对的流动性风险较高时，可以通过出售部分LP来降低自己的风险敞口，同时获取一定的资金用于其他投资。


- 流动性挖矿激励机制

	• 为了进一步吸引流动性提供者，Uniswap V2引入了流动性挖矿激励机制。通过与外部的流动性挖矿协议（如SushiSwap的流动性挖矿）相结合，Uniswap V2的流动性提供者可以在提供流动性的同时，获得额外的代币奖励。这些奖励代币通常具有一定的价值，并且可以在市场上进行交易或用于其他DeFi项目中的质押等操作。这种激励机制不仅提高了流动性提供者的收益预期，还增加了Uniswap V2流动池的深度和稳定性，为交易者提供了更好的交易体验。


- 流动性再平衡机制

	• 由于市场价格的波动，流动池中两种代币的价值可能会出现不平衡的情况。例如，当代币A的价格大幅上涨时，流动池中代币A的价值可能会远远超过代币B的价值，这将导致流动性的分布不均，影响交易对的流动性和价格稳定性。为了应对这种情况，Uniswap V2通过市场机制来实现流动性再平衡。
	
	• 当流动池中代币价值不平衡时，交易者会发现通过在Uniswap V2上交易可以获取套利机会。例如，交易者可以低价买入价值被低估的代币B，并将其兑换成价值被高估的代币A，从而实现套利收益。这种套利行为会不断调整流动池中代币的储备量，使得两种代币的价值逐渐趋于平衡。同时，流动性提供者也可以通过观察流动池中代币价值的变化，适时调整自己的流动性配置，以获取更多的收益。

# 0x03 总结

深入研究Uniswap V2的技术原理和底层逻辑后，Momo对Uniswap V2十分的敬佩。恒定乘积做市商机制(xy=k)是Uniswap V2最核心的创新。这个看似简单的数学公式，却为去中心化交易提供了优雅的解决方案。它不仅能自动调节价格，还能通过滑点机制来平衡大额交易对市场的冲击，有效保护了流动性提供者的利益。在流动性管理方面，Uniswap V2展现出了独特的智慧。LP代币机制让流动性提供者能够灵活管理资金，而流动性挖矿激励和再平衡机制的巧妙设计，则确保了充足的流动性和价格的稳定性。这些机制相互配合，构建出了一个运转流畅的去中心化交易生态。作为DeFi领域的重要基础设施，Uniswap V2展示了去中心化交易所的无限可能。它不仅为用户提供了便捷的交易体验，更为整个DeFi生态系统的发展奠定了坚实基础。


